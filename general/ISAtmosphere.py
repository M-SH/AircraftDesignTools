import numpy as np
from scipy.interpolate import interp1d
import matplotlib.pyplot as plt

from general.Singleton import Singleton


class ISAtmosphere(metaclass=Singleton):
    p0 = 101300  # Pa
    rho0 = 1.225  # kg/m^3
    mu0 = 1.789 * pow(10, -5)  # kg/m/s
    nu0 = 1.460 * pow(10, -5)  # m^2/s

    def __new__(cls):
        if not hasattr(cls, 'instance'):
            cls.instance = super(ISAtmosphere, cls).__new__(cls)
        return cls.instance

    def __init__(self):
        # Altitudes in meters
        self.altitudes = np.array([
            0, 152, 304, 457, 609, 762, 914, 1066, 1219, 1371, 1524, 1676, 1828, 1981, 2133, 2286, 2438, 2590, 2743,
            2895, 3048, 3200, 3352, 3505, 3657, 3810, 3962, 4114, 4267, 4419, 4572, 4724, 4876, 5029, 5181, 5334, 5486,
            5638, 5791, 5943, 6096, 6248, 6400, 6553, 6705, 6858, 7010, 7162, 7315, 7467, 7620, 7772, 7924, 8077, 8229,
            8382, 8534, 8686, 8839, 8991, 9144, 9296, 9448, 9601, 9753, 9906, 10058, 10210, 10363, 10515, 10668, 10820,
            10972, 10999, 11277, 11582, 11887, 12192, 12496, 12801, 13106, 13411, 13716, 14020, 14325, 14630, 14935,
            15240, 15544, 15849, 16154, 16459, 16764, 17068, 17373, 17678, 17983, 18288, 18592, 18897, 19202, 19507,
            19812, 20116, 20421, 20726, 21031, 21336
        ])

        # Temperature in Degree Celcius
        self.temperatures = np.array([
            15.2, 14.2, 13.2, 12.2, 11.2, 10.2, 9.30, 8.30, 7.30, 6.30, 5.30, 4.30, 3.30, 2.30, 1.30, 0.3, -0.6, -1.6,
            -2.6, -3.6, -4.6, -5.6, -6.6, -7.6, -8.6, -9.6, -10.6, -11.5, -12.5, -13.5, -14.5, -15.5, -16.5, -17.5,
            -18.5, -19.5, -20.5, -21.5, -22.4, -23.4, -24.4, -25.4, -26.4, -27.4, -28.4, -29.4, -30.4, -31.4, -32.3,
            -33.3, -34.3, -35.3, -36.3, -37.3, -38.3, -39.3, -40.3, -41.3, -42.3, -43.2, -44.2, -45.2, -46.2, -47.2,
            -48.2, -49.2, -50.2, -51.2, -52.2, -53.2, -54.1, -55.1, -56.1, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3,
            -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3,
            -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3, -56.3
        ])

        # Pressure ratio (p/p0)
        self.pressure_ratio = np.array([
            1, 0.9821, 0.9644, 0.9470, 0.9298, 0.9129, 0.8962, 0.8798, 0.8637, 0.8477, 0.8320, 0.8166, 0.8014, 0.7864,
            0.7716, 0.7571, 0.7428, 0.7287, 0.7148, 0.7012, 0.6877, 0.6745, 0.6614, 0.6486, 0.6360, 0.6236, 0.6113,
            0.5993, 0.5875, 0.5758, 0.5643, 0.5531, 0.5420, 0.5311, 0.5203, 0.5098, 0.4994, 0.4892, 0.4791, 0.4693,
            0.4595, 0.4500, 0.4406, 0.4314, 0.4223, 0.4134, 0.4046, 0.3960, 0.3876, 0.3793, 0.3711, 0.3631, 0.3552,
            0.3474, 0.3398, 0.3324, 0.3250, 0.3178, 0.3107, 0.3038, 0.2970, 0.2903, 0.2837, 0.2772, 0.2709, 0.2647,
            0.2586, 0.2526, 0.2467, 0.2410, 0.2353, 0.2298, 0.2243, 0.2234, 0.2138, 0.2038, 0.1942, 0.1851, 0.1764,
            0.1681, 0.1602, 0.1527, 0.1456, 0.1387, 0.1322, 0.1260, 0.1201, 0.1145, 0.1091, 0.1040, 0.09909, 0.09444,
            0.09001, 0.08579, 0.08176, 0.07793, 0.07427, 0.07079, 0.06746, 0.06430, 0.06128, 0.05841, 0.05566, 0.05305,
            0.05056, 0.04819, 0.04593, 0.04377
        ])

        # Density ratio (rho/rho0)
        self.density_ratio = np.array([
            1, 0.9855, 0.9711, 0.9568, 0.9428, 0.9289, 0.9151, 0.9015, 0.8881, 0.8748, 0.8617, 0.8487, 0.8359, 0.8232,
            0.8106, 0.7983, 0.7860, 0.7739, 0.7620, 0.7501, 0.7385, 0.7269, 0.7155, 0.7043, 0.6932, 0.6822, 0.6713,
            0.6606, 0.6500, 0.6396, 0.6292, 0.6190, 0.6090, 0.5990, 0.5892, 0.5795, 0.5699, 0.5604, 0.5511, 0.5419,
            0.5328, 0.5238, 0.5150, 0.5062, 0.4976, 0.4891, 0.4806, 0.4723, 0.4642, 0.4561, 0.4481, 0.4402, 0.4325,
            0.4248, 0.4173, 0.4098, 0.4025, 0.3953, 0.3881, 0.3811, 0.3741, 0.3673, 0.3605, 0.3539, 0.3473, 0.3408,
            0.3345, 0.3282, 0.3220, 0.3159, 0.3099, 0.3039, 0.2981, 0.2971, 0.2843, 0.2710, 0.2583, 0.2462, 0.2346,
            0.2236, 0.2131, 0.2031, 0.1936, 0.1845, 0.1758, 0.1676, 0.1597, 0.1522, 0.1451, 0.1383, 0.1318, 0.1256,
            0.1197, 0.1141, 0.1087, 0.1036, 0.09878, 0.09414, 0.08972, 0.08551, 0.08150, 0.07768, 0.07403, 0.07056,
            0.06725, 0.06409, 0.06108, 0.05822
        ])

        self.viscosity_ratio = np.array(
            [1, 0.9973, 0.9947, 0.9920, 0.9893, 0.9866, 0.9839, 0.9812, 0.9785, 0.9758, 0.9731, 0.9704, 0.9677, 0.9649,
             0.9622, 0.9595, 0.9567, 0.9540, 0.9512, 0.9485, 0.9457, 0.9430, 0.9402, 0.9374, 0.9347, 0.9319, 0.9291,
             0.9263, 0.9235, 0.9207, 0.9179, 0.9151, 0.9123, 0.9094, 0.9066, 0.9038, 0.9009, 0.8981, 0.8953, 0.8924,
             0.8895, 0.8867, 0.8838, 0.8809, 0.8781, 0.8752, 0.8723, 0.8694, 0.8665, 0.8636, 0.8607, 0.8578, 0.8548,
             0.8519, 0.8490, 0.8460, 0.8431, 0.8402, 0.8372, 0.8342, 0.8313, 0.8283, 0.8253, 0.8223, 0.8194, 0.8164,
             0.8134, 0.8104, 0.8073, 0.8043, 0.8013, 0.7983, 0.7952, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947,
             0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947,
             0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947, 0.7947,
             0.7947, 0.7947, 0.7947])

        self.kinematic_viscosity_ratio = np.array(
            [1, 1.0121, 1.0243, 1.0367, 1.0493, 1.0622, 1.0752, 1.0884, 1.1018, 1.1155, 1.1293, 1.1434, 1.1577, 1.1722,
             1.1870, 1.2020, 1.2172, 1.2327, 1.2484, 1.2644, 1.2807, 1.2972, 1.3140, 1.3310, 1.3484, 1.3660, 1.3840,
             1.4022, 1.4207, 1.4396, 1.4588, 1.4783, 1.4981, 1.5183, 1.5388, 1.5596, 1.5809, 1.6025, 1.6244, 1.6468,
             1.6696, 1.6927, 1.7163, 1.7403, 1.7647, 1.7895, 1.8148, 1.8406, 1.8668, 1.8935, 1.9207, 1.9484, 1.9766,
             2.0053, 2.0345, 2.0643, 2.0947, 2.1256, 2.1571, 2.1892, 2.2219, 2.2553, 2.2892, 2.3239, 2.3592, 2.3952,
             2.4318, 2.4692, 2.5074, 2.5463, 2.5859, 2.6264, 2.6677, 2.6751, 2.7948, 2.9324, 3.0768, 3.2283, 3.3872,
             3.5540, 3.7290, 3.9126, 4.1052, 4.3073, 4.5194, 4.7419, 4.9754, 5.2203, 5.4773, 5.7470, 6.0300, 6.3268,
             6.6383, 6.9652, 7.3081, 7.6679, 8.0454, 8.4416, 8.8572, 9.2932, 9.7508, 10.231, 10.735, 11.263, 11.818,
             12.399, 13.010, 13.650])

        # Speed of sound in m/s
        self.speed_of_sound = np.array([
            340.3, 339.7, 339.1, 338.5, 338.0, 337.4, 336.8, 336.2, 335.6, 335.0, 334.4, 333.8, 333.2, 332.6, 332.0,
            331.4, 330.8, 330.2, 329.6, 329.0, 328.4, 327.8, 327.2, 326.6, 326.0, 325.4, 324.7, 324.1, 323.5, 322.9,
            322.3, 321.7, 321.0, 320.4, 319.8, 319.2, 318.5, 317.9, 317.3, 316.7, 316.0, 315.4, 314.8, 314.1, 313.5,
            312.9, 312.2, 311.6, 311.0, 310.3, 309.7, 309.0, 308.4, 307.7, 307.1, 306.4, 305.8, 305.1, 304.5, 303.8,
            303.2, 302.5, 301.9, 301.2, 300.5, 299.9, 299.2, 298.6, 297.9, 297.2, 296.5, 295.9, 295.2, 295.1, 295.1,
            295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1,
            295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1, 295.1,
            295.1, 295.1, 295.1
        ])

        # Build interpolation functions (equivalent to Apache LinearInterpolator)
        self.temperature_fn = interp1d(self.altitudes, self.temperatures)
        self.pressure_ratio_fn = interp1d(self.altitudes, self.pressure_ratio)
        self.density_ratio_fn = interp1d(self.altitudes, self.density_ratio)
        self.viscosity_ratio_fn = interp1d(self.altitudes, self.viscosity_ratio)
        self.kinematic_viscosity_ratio_fn = interp1d(self.altitudes, self.kinematic_viscosity_ratio)
        self.speed_of_sound_fn = interp1d(self.altitudes, self.speed_of_sound)

    def get_temperature(self, altitude_m):
        return self.temperature_fn(altitude_m)

    def get_pressure(self, altitude_m):
        return self.pressure_ratio_fn(altitude_m) * self.p0

    def get_density(self, altitude_m):
        return self.density_ratio_fn(altitude_m) * self.rho0

    def get_viscosity(self, altitude_m):
        return self.viscosity_ratio_fn(altitude_m) * self.mu0

    def get_kinematic_viscosity(self, altitude_m):
        return self.kinematic_viscosity_ratio_fn(altitude_m) * self.nu0

    def get_speed_of_sound(self, altitude_m):
        return self.speed_of_sound_fn(altitude_m)

    # ------------------------------
    # Plotting functions
    # ------------------------------
    def plot_temperature(self):
        plt.figure()
        plt.plot(self.temperatures, self.altitudes)
        plt.ylabel("Altitude [m]")
        plt.xlabel("Temperature [°C]")
        plt.title("Temperature vs Altitude")
        plt.grid(True)
        plt.show()

    def plot_pressure(self):
        plt.figure()
        plt.plot(self.get_pressure(self.altitudes), self.altitudes)
        plt.ylabel("Altitude [m]")
        plt.xlabel("Pressure [Pa]")
        plt.title("Pressure Ratio vs Altitude")
        plt.grid(True)
        plt.show()

    def plot_density(self):
        plt.figure()
        plt.plot(self.get_density(self.altitudes), self.altitudes)
        plt.ylabel("Altitude [m]")
        plt.xlabel("Density [kg/m³]")
        plt.title("Density Ratio vs Altitude")
        plt.grid(True)
        plt.show()

    def plot_speed_of_sound(self):
        plt.figure()
        plt.plot(self.get_speed_of_sound(self.altitudes), self.altitudes)
        plt.ylabel("Altitude [m]")
        plt.xlabel("Speed of Sound [m/s]")
        plt.title("Speed of Sound vs Altitude")
        plt.grid(True)
        plt.show()


if __name__ == "__main__":
    atm = ISAtmosphere()
    atm.plot_temperature()
    atm.plot_pressure()
    atm.plot_density()
    atm.plot_speed_of_sound()
